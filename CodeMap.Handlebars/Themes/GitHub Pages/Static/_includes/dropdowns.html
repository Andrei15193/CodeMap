{% comment %}
Parameters:
- `item_include_name` (defaults to `dropdown-item.html`)
- `item_separator_include_name` (defaults to `dropdown-item-separator.html`)

Groups pages that have the `is_dropdown_landing_page` flag set to true and have a configured `dropdown` path, these
can be set in the front matter of a page or through Jekyll configuration files.

```
is_dropdown_landing_page: true
dropdown:
- Blog
- Latest
```

From the above example, a dropdown structure will be generated where all pages that have the 1st dropdown item `Blog`
will be grouped together where each 2nd item will point to the actual page. The `is_dropdown_landing_page` flag indicates
the landing page when multiple pages have the same dropdown path.

In order to generate the dropdown items themselves, this include depends on two other includes which are provided through
the `item_include_name` and `item_separator_include_name` parameters which default to `dropdown-item.html` and
`dropdown-item-separator.html` respectively.

The item include receives a number of parameters that are useful when generating a dropdown item:
* `display_text`: the last item in the dropdown path (in the given example this would be `Latest`)
* `is_active`: a flag indicating that dropdown item is part of the dropdown path of the page being processed
  (in the given example, both `Blog` and `Blog / Latest` are ative items for any page having the `Blog, Latest` dropdown path,
   but a page having the dropdown path `Latest` or `Lastest / Blog` will not mark either item as active as they would result
   in other dropdown item groupings, or trees)
* `depth`: this is the depth in the dropdown path starting with 1 (in the given example, the `Blog` item has the depth of `1`
  while `Blog / Latest` has the depth of `2`)
* `page`: this is the landing page for a dropdown item, may not always have value (in the given example, the `Blog` item does
  not have a landing page, but `Blog / Latest` does)
* `child_pages_content`: an HTML capture of child dropdown items, may not always have value (in the given example, the
  `Blog / Latest` item does not have any child page contents, however the `Blog` item will received the HTML captures
  that were generated for all child items, such as `Blog / Latest`)
* `is_version_item`: a flag indicating whether the `display_text` is a valid SemVer

The item separator include receives just two parameters which are exactly the same as the ones for the item include. These are
the `depth` and `page` parameters.
{% endcomment %}

{% assign item_include_name = include.item_include_name | default: 'dropdown-item.html' %}
{% assign item_separator_include_name = include.item_separator_include_name | default: 'dropdown-item-separator.html' %}

{% comment %}
enum Precedence {
    Release = 4,
    Build = 3,
    PreRelease = 2,
    TextIdentifier = 1,
    NumberIdentifier = 0
}

tuple: SemVer [
    major: number >= 0,
    minor: number >= 0,
    patch: number >= 0,
    { release version => Precedence.Release (4), pre-release version => Precedence.PreRelease (2) }
    ...[
        if (identifier is number and >= 0)
            ...[ Precedence.NumberIdentifier (0), identifier as number ]
        else
            ...[ Precedence.TextIdentifier (1), identifier ]
    ],
    { without build version => Precedence.Release (4), with build version => Precedence.Build (3) }
    ...[
        if (identifier is number and >= 0)
            ...[ Precedence.NumberIdentifier (0), identifier as number ]
        else
            ...[ Precedence.TextIdentifier (1), identifier ]
    ]
]

A SemVer tuple is an array of items where the first 3 are the base version identifiers, always numeric identifiers (these are number greater than or equal to 0)
followed by the version precedence (release = 4, pre-release = 2)
followed by the pre-release version identifier pairs made out of the precedence for text or number identifiers then the identifier itself accordingly
followed by the version precedence (release = 4, build = 3)
followed by the build version identifier pairs which are just like the pre-release version identifier pairs

When comparing any two versions, values at the same index have the same type, thus numbers are compared with numbers and strings with strings.
To determine which version has precedence over another simply compare the individual items lexicographically.

Example:
1.0.0                  => [1, 0, 0, Release   , Release]
1.0.0-alpha            => [1, 0, 0, PreRelease, TextIdentifier, 'alpha'       ]
1.0.0-alpha.1          => [1, 0, 0, PreRelease, TextIdentifier, 'alpha'       , NumberIdentifier, 1               , Release]
1.0.0-alpha.1+build.1  => [1, 0, 0, PreRelease, TextIdentifier, 'alpha'       , NumberIdentifier, 1               , Build  , TextIdentifier, 'build', NumberIdentifier, 1]
1.0.0-alpha+build      => [1, 0, 0, PreRelease, TextIdentifier, 'alpha'       , Build           , TextIdentifier  , 'build']
1.0.0+build            => [1, 0, 0, Release   , Build         , TextIdentifier, 'build']
1.0.0+build.1          => [1, 0, 0, Release   , Build         , TextIdentifier, 'build'         , NumberIdentifier, 1      ]
1.0.0+build.2          => [1, 0, 0, Release   , Build         , TextIdentifier, 'build'         , NumberIdentifier, 2      ]
2.0.0                  => [2, 0, 0, Release   , Release]
{% endcomment %}

{% assign dropdown_tree = '' | split: ',' | where: 'an', 'array: [tuple dropdown_node: [id, parent_id?, display_text, path, page?]]' %}

{% for page in site.pages %}
    {% if page.dropdown.size and page.dropdown.size > 0 and page.is_dropdown_landing_page %}
        {% assign parent_id = nil %}
        {% for element in page.dropdown %}
            {% assign level = forloop.index %}
            {% assign index_in_dropdown_tree = -1 %}
            {% for dropdown_node in dropdown_tree %}
                {% assign dropdown_node_index = forloop.index0 %}
                {% assign dropdown_node_path = dropdown_node[3] %}
                {% if dropdown_node_path.size == level %}
                    {% for dropdown_node_path_element in dropdown_node_path %}
                        {% assign is_matching = true %}
                        {% if dropdown_node_path_element != page.dropdown[forloop.index0] %}
                            {% assign is_matching = false %}
                            {% break %}
                        {% endif %}
                    {% endfor %}
                    {% if is_matching %}
                        {% assign index_in_dropdown_tree = dropdown_node_index %}
                    {% endif %}
                {% endif %}
            {% endfor %}

            {% if index_in_dropdown_tree == -1 %}
                {% assign new_dropdown_node_id = dropdown_tree.size %}
                {% assign new_dropdown_node_path = page.dropdown | slice: 0, level %}
                {%
                    assign new_dropdown_node = '' | split: ',' | where: 'a', 'dropdown_node'
                        | push: new_dropdown_node_id
                        | push: parent_id
                        | push: element
                        | push: new_dropdown_node_path
                %}

                {% if level == page.dropdown.size %}
                    {% assign new_dropdown_node = new_dropdown_node | push: page %}
                {% endif %}

                {% assign index_in_dropdown_tree = dropdown_tree.size %}
                {% assign dropdown_tree = dropdown_tree | push: new_dropdown_node %}
            {% endif %}

            {% assign dropdown_node = dropdown_tree[index_in_dropdown_tree] %}
            {% assign dropdown_node_id = dropdown_node[0] %}
            {% assign parent_id = dropdown_node_id %}
        {% endfor %}
    {% endif %}
{% endfor %}

{% assign dropdown_node_parent_ids = '' | split: ',' | where: 'an', 'array: number' %}
{% for dropdown_node in dropdown_tree %}
    {% assign dropdown_node_parent_id = dropdown_node[1] %}
    {% assign dropdown_node_parent_ids = dropdown_node_parent_ids | push: dropdown_node_parent_id %}
{% endfor %}
{% assign dropdown_node_parent_ids = dropdown_node_parent_ids | uniq %}

{% assign dropdown_nodes_by_parent_ids = '' | split: ',' | where: 'an', 'array: [tuple: [parent_id, dropdown_node]]' %}
{% for parent_id in dropdown_node_parent_ids %}
    {% assign dropdown_nodes_by_parent_id = '' | split: ',' | where: 'an', 'array: [dropdown_node]' %}
    {% for dropdown_node in dropdown_tree %}
        {% assign dropdown_node_parent_id = dropdown_node[1] %}
        {% if dropdown_node_parent_id == parent_id %}
            {% assign dropdown_nodes_by_parent_id = dropdown_nodes_by_parent_id | push: dropdown_node %}
        {% endif %}
    {% endfor %}

    {%
        assign dropdown_nodes_by_parent_id_grouping = '' | split: ',' | where: 'a', 'tuple: [parent_id: number, dropdown_nodes: array: [dropdown_node]]'
            | push: parent_id
            | push: dropdown_nodes_by_parent_id
    %}
    {% assign dropdown_nodes_by_parent_ids = dropdown_nodes_by_parent_ids | push: dropdown_nodes_by_parent_id_grouping %}
{% endfor %}

{%
    assign sorted_dropdown_nodes_by_parent_ids = '' | split: ','
        | where: 'an', 'array: [tuple sorted_dropdown_nodes_by_parent_id: [parent_id: number, version_dropdown_nodes: array: [dropdown_node], other_dropdown_nodes: array: [dropdown_node]]]'
%}

{% for dropdown_nodes_by_parent_id in dropdown_nodes_by_parent_ids %}
    {% assign parent_id = dropdown_nodes_by_parent_id[0] %}
    {% assign dropdown_nodes = dropdown_nodes_by_parent_id[1] %}

    {% assign versioned_dropdown_nodes = '' | split: ',' | where: 'an', 'array: [dropdown_node]' %}
    {% assign other_dropdown_nodes = '' | split: ',' | where: 'an', 'array: [dropdown_node]' %}

    {% assign versioned_dropdown_nodes_info = '' | split: ',' | where: 'an', 'array: [tuple dropdown_node_info: [dropdown_node, dropdown_node_version: SemVer]]' %}
    {% for dropdown_node in dropdown_nodes %}
        {% assign display_text = dropdown_node[2] %}
        {% assign dropdown_node_version_string = display_text %}

        {% assign dropdown_node_build_version_split = dropdown_node_version_string | split: '+' %}
        {% if dropdown_node_build_version_split.size > 1 %}
            {% assign dropdown_node_build_version_string = dropdown_node_build_version_split | slice: 1, dropdown_node_build_version_split.size | join: '+' %}
        {% else %}
            {% assign dropdown_node_build_version_string = nil %}
        {% endif %}

        {% assign dropdown_node_pre_release_version_split = dropdown_node_build_version_split | first | split: '-' %}
        {% assign dropdown_node_base_version_string = dropdown_node_pre_release_version_split | first %}
        {% if dropdown_node_pre_release_version_split.size > 1 %}
            {% assign dropdown_node_pre_release_version_string = dropdown_node_pre_release_version_split | slice: 1, dropdown_node_pre_release_version_split.size | join: '-' %}
        {% else %}
            {% assign dropdown_node_pre_release_version_string = nil %}
        {% endif %}

        {% assign dropdown_node_base_version = dropdown_node_base_version_string | split: '.' %}
        {% assign dropdown_node_semver = '' | split: ',' | where: 'a', 'SemVer' %}
        {% for base_version_identifier in dropdown_node_base_version %}
            {% assign base_version_number_identifier = base_version_identifier | plus: 0 %}
            {% if base_version_identifier == '0' or base_version_number_identifier > 0 %}
                {% assign dropdown_node_semver = dropdown_node_semver | push: base_version_number_identifier %}
            {% endif %}
        {% endfor %}

        {% if dropdown_node_semver.size == 3 %}
            {% if dropdown_node_pre_release_version_string %}
                {% assign dropdown_node_pre_release_version = dropdown_node_pre_release_version_string | split: '.' %}

                {% assign dropdown_node_semver = dropdown_node_semver | push: 2 %}
                {% for dropdown_node_pre_release_version_identifier in dropdown_node_pre_release_version %}
                    {% assign dropdown_node_pre_release_version_number_identifier = dropdown_node_pre_release_version_identifier | plus: 0 %}
                    {% if dropdown_node_pre_release_version_identifier == '0' or dropdown_node_pre_release_version_number_identifier > 0 %}
                        {% assign dropdown_node_semver = dropdown_node_semver | push: 0 | push: dropdown_node_pre_release_version_number_identifier %}
                    {% else %}
                        {% assign dropdown_node_semver = dropdown_node_semver | push: 1 | push: dropdown_node_pre_release_version_identifier %}
                    {% endif %}
                {% endfor %}
            {% else %}
                {% assign dropdown_node_semver = dropdown_node_semver | push: 4 %}
            {% endif %}

            {% if dropdown_node_build_version_string %}
                {% assign dropdown_node_build_version = dropdown_node_build_version_string | split: '.' %}

                {% assign dropdown_node_semver = dropdown_node_semver | push: 3 %}
                {% for dropdown_node_build_version_identifier in dropdown_node_build_version %}
                    {% assign dropdown_node_build_version_number_identifier = dropdown_node_build_version_identifier | plus: 0 %}
                    {% if dropdown_node_build_version_identifier == '0' or dropdown_node_build_version_number_identifier > 0 %}
                        {% assign dropdown_node_semver = dropdown_node_semver | push: 0 | push: dropdown_node_build_version_number_identifier %}
                    {% else %}
                        {% assign dropdown_node_semver = dropdown_node_semver | push: 1 | push: dropdown_node_build_version_identifier %}
                    {% endif %}
                {% endfor %}
            {% else %}
                {% assign dropdown_node_semver = dropdown_node_semver | push: 4 %}
            {% endif %}

            {%
                assign dropdown_node_info = '' | split: ',' | where: 'a', 'dropdown_node_info'
                    | push: dropdown_node
                    | push: dropdown_node_semver
            %}
            {% assign versioned_dropdown_nodes_info = versioned_dropdown_nodes_info | push: dropdown_node_info %}
        {% else %}
            {% assign other_dropdown_nodes = other_dropdown_nodes | push: dropdown_node %}
        {% endif %}
    {% endfor %}

    {% for number in (1..versioned_dropdown_nodes_info.size) %}
        {% assign max_versioned_dropdown_node_info = versioned_dropdown_nodes_info | first %}
        {% assign versioned_dropdown_nodes_info_new = '' | split: ',' | where: 'an', 'array: [dropdown_node_info]' %}

        {% for versioned_dropdown_node_info in versioned_dropdown_nodes_info offset: 1 %}
            {% assign is_current_greater = nil %}

            {% assign max_versioned_dropdown_node_info_semver = max_versioned_dropdown_node_info[1] %}
            {% assign versioned_dropdown_node_info_semver = versioned_dropdown_node_info[1] %}
            {% assign min_semver_length = max_versioned_dropdown_node_info_semver.size %}
            {% if versioned_dropdown_node_info_semver.size < min_semver_length %}
                {% assign min_semver_length = versioned_dropdown_node_info_semver.size %}
            {% endif %}

            {% for semver_part_index in (0..min_semver_length) limit: min_semver_length %}
                {% if versioned_dropdown_node_info_semver[semver_part_index] > max_versioned_dropdown_node_info_semver[semver_part_index] %}
                    {% assign is_current_greater = true %}
                    {% break %}
                {% elsif max_versioned_dropdown_node_info_semver[semver_part_index] > versioned_dropdown_node_info_semver[semver_part_index] %}
                    {% assign is_current_greater = false %}
                    {% break %}
                {% endif %}
            {% endfor %}

            {% if is_current_greater == nil %}
                {% if max_versioned_dropdown_node_info_semver.size < versioned_dropdown_node_info_semver.size %}
                    {% assign is_current_greater = true %}
                {% else %}
                    {% assign is_current_greater = false %}
                {% endif %}
            {% endif %}

            {% if is_current_greater %}
                {% assign versioned_dropdown_nodes_info_new = versioned_dropdown_nodes_info_new | push: max_versioned_dropdown_node_info %}
                {% assign max_versioned_dropdown_node_info = versioned_dropdown_node_info %}
            {% else %}
                {% assign versioned_dropdown_nodes_info_new = versioned_dropdown_nodes_info_new | push: versioned_dropdown_node_info %}
            {% endif %}
        {% endfor %}

        {% assign max_dropdown_node = max_versioned_dropdown_node_info[0] %}
        {% assign versioned_dropdown_nodes = versioned_dropdown_nodes | push: max_dropdown_node %}
        {% assign versioned_dropdown_nodes_info = versioned_dropdown_nodes_info_new %}
    {% endfor %}

    {% assign other_dropdown_nodes_temp = '' | split: ',' | where: 'an', 'array: [dropdown_node_info]' %}
    {% for number in (1..other_dropdown_nodes.size) %}
        {% assign min_dropdown_node = other_dropdown_nodes | first %}
        {% assign other_dropdown_nodes_new = '' | split: ',' | where: 'an', 'array: [dropdown_node_info]' %}

        {% for dropdown_node in other_dropdown_nodes offset: 1 %}
            {% assign min_dropdown_node_display_text = min_dropdown_node[2] %}
            {% assign dropdown_node_display_text = dropdown_node[2] %}

            {% if dropdown_node_display_text < min_dropdown_node_display_text %}
                {% assign other_dropdown_nodes_new = other_dropdown_nodes_new | push: min_dropdown_node %}
                {% assign min_dropdown_node = dropdown_node %}
            {% else %}
                {% assign other_dropdown_nodes_new = other_dropdown_nodes_new | push: dropdown_node %}
            {% endif %}
        {% endfor %}

        {% assign other_dropdown_nodes_temp = other_dropdown_nodes_temp | push: min_dropdown_node %}
        {% assign other_dropdown_nodes = other_dropdown_nodes_new %}
    {% endfor %}
    {% assign other_dropdown_nodes = other_dropdown_nodes_temp %}

    {%
        assign sorted_dropdown_nodes_by_parent_id = '' | split: ','
            | where: 'a', 'sorted_dropdown_nodes_by_parent_id'
            | push: parent_id
            | push: versioned_dropdown_nodes
            | push: other_dropdown_nodes
    %}
    {% assign sorted_dropdown_nodes_by_parent_ids = sorted_dropdown_nodes_by_parent_ids | push: sorted_dropdown_nodes_by_parent_id %}
{% endfor %}

{% assign condensed_dropdown_nodes_by_parent_ids = '' | split: ',' | where: 'an', 'array: [tuple: [parent_id: number, capture]]' %}
{% for sorted_dropdown_nodes_by_parent_id in sorted_dropdown_nodes_by_parent_ids reversed %}
    {% assign parent_id = sorted_dropdown_nodes_by_parent_id[0] %}
    {% assign version_dropdown_nodes = sorted_dropdown_nodes_by_parent_id[1] %}
    {% assign other_dropdown_nodes = sorted_dropdown_nodes_by_parent_id[2] %}

    {% capture dropdown_nodes_capture %}
        {% for dropdown_node in version_dropdown_nodes %}
            {% assign dropdown_node_id = dropdown_node[0] %}
            {% assign dropdown_node_display_text = dropdown_node[2] %}
            {% assign dropdown_node_path = dropdown_node[3] %}
            {% assign dropdown_node_depth = dropdown_node_path.size %}
            {% assign dropdown_node_page = dropdown_node[4] %}

            {% assign dropdown_node_child_pages_content = nil %}
            {% for condensed_dropdown_nodes_by_parent_id in condensed_dropdown_nodes_by_parent_ids %}
                {% assign condensed_dropdown_nodes_parent_id = condensed_dropdown_nodes_by_parent_id[0] %}
                {% if condensed_dropdown_nodes_parent_id == dropdown_node_id %}
                    {% assign dropdown_node_child_pages_content = condensed_dropdown_nodes_by_parent_id[1] %}
                    {% break %}
                {% endif %}
            {% endfor %}

            {% assign is_active = false %}
            {% if page.dropdown and page.dropdown.size > 0  %}
                {% assign is_active = true %}
                {% for dropdown_node_path_element in dropdown_node_path %}
                    {% if dropdown_node_path_element != page.dropdown[forloop.index0] %}
                        {% assign is_active = false %}
                        {% break %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {%
                include {{ item_include_name }}
                    display_text=dropdown_node_display_text
                    is_active=is_active
                    depth=dropdown_node_depth
                    page=dropdown_node_page
                    child_pages_content=dropdown_node_child_pages_content
                    is_version_item=true
            %}
        {% endfor %}

        {% if version_dropdown_nodes.size > 0 and other_dropdown_nodes.size > 0 %}
            {%
                include {{ item_separator_include_name }}
                    depth=dropdown_node_depth
                    page=dropdown_node_page
            %}
        {% endif %}

        {% for dropdown_node in other_dropdown_nodes %}
            {% assign dropdown_node_id = dropdown_node[0] %}
            {% assign dropdown_node_display_text = dropdown_node[2] %}
            {% assign dropdown_node_path = dropdown_node[3] %}
            {% assign dropdown_node_depth = dropdown_node_path.size %}
            {% assign dropdown_node_page = dropdown_node[4] %}

            {% assign dropdown_node_child_pages_content = nil %}
            {% for condensed_dropdown_nodes_by_parent_id in condensed_dropdown_nodes_by_parent_ids %}
                {% assign condensed_dropdown_nodes_parent_id = condensed_dropdown_nodes_by_parent_id[0] %}
                {% if condensed_dropdown_nodes_parent_id == dropdown_node_id %}
                    {% assign dropdown_node_child_pages_content = condensed_dropdown_nodes_by_parent_id[1] %}
                    {% break %}
                {% endif %}
            {% endfor %}

            {% assign is_active = false %}
            {% if page.dropdown and page.dropdown.size > 0  %}
                {% assign is_active = true %}
                {% for dropdown_node_path_element in dropdown_node_path %}
                    {% if dropdown_node_path_element != page.dropdown[forloop.index0] %}
                        {% assign is_active = false %}
                        {% break %}
                    {% endif %}
                {% endfor %}
            {% endif %}

            {%
                include {{ item_include_name }}
                    display_text=dropdown_node_display_text
                    is_active=is_active
                    depth=dropdown_node_depth
                    page=dropdown_node_page
                    child_pages_content=dropdown_node_child_pages_content
                    is_version_item=false
            %}
        {% endfor %}
    {% endcapture %}

    {%
        assign condensed_dropdown_nodes_by_parent_id_grouping = '' | split: ',' | where: 'a', 'tuple: [parent_id: number, capture]'
            | push: parent_id
            | push: dropdown_nodes_capture
    %}
    {% assign condensed_dropdown_nodes_by_parent_ids = condensed_dropdown_nodes_by_parent_ids | push: condensed_dropdown_nodes_by_parent_id_grouping %}
{% endfor %}

{% for condensed_dropdown_nodes_by_parent_id in condensed_dropdown_nodes_by_parent_ids %}
    {% assign parent_id = condensed_dropdown_nodes_by_parent_id[0] %}
    {% assign dropdown_nodes_capture = condensed_dropdown_nodes_by_parent_id[1] %}
    {% unless parent_id %}
        {{ dropdown_nodes_capture }}
    {% endunless %}
{% endfor %}